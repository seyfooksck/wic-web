const axios = require('axios');
const cheerio = require('cheerio');
const fs = require('fs-extra');
const path = require('path');
const url = require('url');

// ƒ∞ndirmek istediƒüiniz template URL'leri
const templateUrls = [
    'https://seyfooksck.dev/', // Ana sayfa
];

// Konfig√ºrasyon
const config = {
    // WordPress benzeri yapƒ±larƒ± destekle (uzantƒ±sƒ±z URL'ler)
    supportWordPressStructure: true,
    
    // ƒ∞ndirme derinliƒüi (ka√ß seviye link takip edilecek)
    maxDepth: 2,
    
    // Timeout s√ºreleri
    requestTimeout: 30000,
    
    // Hangi dosya t√ºrlerinin indirileceƒüi
    fileExtensions: {
        images: ['.jpg', '.jpeg', '.png', '.gif', '.svg', '.webp', '.ico', '.bmp'],
        styles: ['.css'],
        scripts: ['.js'],
        fonts: ['.woff', '.woff2', '.ttf', '.eot', '.otf']
    }
};

// Dosya indirme fonksiyonu
async function downloadFile(fileUrl, filePath, cookieHeader = null) {
    try {
        const options = {
            method: 'get',
            url: fileUrl,
            responseType: 'stream',
            timeout: config.requestTimeout
        };
        
        // Cookie varsa header'a ekle
        if (cookieHeader) {
            options.headers = {
                'Cookie': cookieHeader
            };
        }
        
        const response = await axios(options);
        
        await fs.ensureDir(path.dirname(filePath));
        const writer = fs.createWriteStream(filePath);
        response.data.pipe(writer);
        
        return new Promise((resolve, reject) => {
            writer.on('finish', resolve);
            writer.on('error', reject);
        });
    } catch (error) {
        console.log(`‚ö†Ô∏è  ${fileUrl} indirilemedi: ${error.message}`);
    }
}

// Dosya yolunu orijinal yapƒ±sƒ±nƒ± koruyarak d√ºzenle
function getLocalFilePath(originalPath, outputDir) {
    // ./ ile ba≈ülayan yollarƒ± temizle
    let cleanPath = originalPath.replace(/^\.\//, '');
    
    // Dosya yolunu output directory ile birle≈ütir
    return path.join(outputDir, cleanPath);
}

// Relatif yolu orijinal yapƒ±da koru
function getRelativePathForHtml(originalPath) {
    // ./ ile ba≈ülayan yollarƒ± koru
    if (originalPath.startsWith('./')) {
        return originalPath;
    }
    // Ba≈üka bir ≈üekilde relative ise ./ ekle
    if (!originalPath.startsWith('/') && !originalPath.startsWith('http')) {
        return './' + originalPath;
    }
    return originalPath;
}

// CSS dosyalarƒ±ndaki URL'leri i≈üleme
async function processCssUrls(cssContent, cssUrl, outputDir, cookieHeader = null, downloadedFiles = new Set()) {
    const baseUrl = cssUrl.substring(0, cssUrl.lastIndexOf('/'));
    const urlRegex = /url\(['"]?([^'")\s]+)['"]?\)/gi;
    let match;
    
    while ((match = urlRegex.exec(cssContent)) !== null) {
        const resourceUrl = match[1];
        if (!resourceUrl.startsWith('http') && !resourceUrl.startsWith('data:')) {
            const fullUrl = url.resolve(baseUrl + '/', resourceUrl);
            
            // Dosya daha √∂nce indirildi mi kontrol et
            if (!downloadedFiles.has(fullUrl)) {
                downloadedFiles.add(fullUrl);
                const localPath = getLocalFilePath(resourceUrl, outputDir);
                
                await downloadFile(fullUrl, localPath, cookieHeader);
                console.log(`üìÑ CSS resource: ${resourceUrl}`);
            }
        }
    }
    
    return cssContent;
}

// HTML sayfalarƒ±ndaki linkleri bulma
function findHtmlLinks($, baseUrl) {
    const htmlLinks = new Set();
    
    // Men√º linklerini bul
    $('a[href]').each((i, elem) => {
        const href = $(elem).attr('href');
        if (href && !href.startsWith('http') && !href.startsWith('//') && !href.startsWith('#') && !href.startsWith('mailto:') && !href.startsWith('tel:')) {
            // WordPress yapƒ±sƒ±nƒ± destekle
            if (config.supportWordPressStructure) {
                // .html ile biten veya uzantƒ±sƒ±z linkler
                if (href.endsWith('.html') || (!href.includes('.') && href !== '/' && href !== '')) {
                    const fullUrl = url.resolve(baseUrl + '/', href);
                    htmlLinks.add(fullUrl);
                }
            } else {
                // Sadece .html ile biten linkler
                if (href.endsWith('.html')) {
                    const fullUrl = url.resolve(baseUrl + '/', href);
                    htmlLinks.add(fullUrl);
                }
            }
        }
    });
    
    // Navigation linklerini bul
    $('nav a[href], .navbar a[href], .menu a[href], .navigation a[href]').each((i, elem) => {
        const href = $(elem).attr('href');
        if (href && !href.startsWith('http') && !href.startsWith('//') && !href.startsWith('#') && !href.startsWith('mailto:') && !href.startsWith('tel:')) {
            if (config.supportWordPressStructure) {
                if (href.endsWith('.html') || (!href.includes('.') && href !== '/' && href !== '')) {
                    const fullUrl = url.resolve(baseUrl + '/', href);
                    htmlLinks.add(fullUrl);
                }
            } else {
                if (href.endsWith('.html')) {
                    const fullUrl = url.resolve(baseUrl + '/', href);
                    htmlLinks.add(fullUrl);
                }
            }
        }
    });
    
    return Array.from(htmlLinks);
}

// URL'nin dosya mƒ± sayfa mƒ± olduƒüunu kontrol et
function isPageUrl(urlString) {
    const parsedUrl = url.parse(urlString);
    const pathname = parsedUrl.pathname;
    
    // .html ile bitiyorsa kesinlikle sayfa
    if (pathname.endsWith('.html')) {
        return true;
    }
    
    // WordPress yapƒ±sƒ± destekleniyorsa ve uzantƒ± yoksa sayfa olarak kabul et
    if (config.supportWordPressStructure) {
        const hasExtension = path.extname(pathname) !== '';
        return !hasExtension && pathname !== '/' && pathname !== '';
    }
    
    return false;
}

// Sayfa dosya adƒ±nƒ± ve klas√∂r yapƒ±sƒ±nƒ± belirleme
function getPageFileName(urlString) {
    const parsedUrl = url.parse(urlString);
    let pathname = parsedUrl.pathname;
    
    // Son / karakterini kaldƒ±r
    if (pathname.endsWith('/')) {
        pathname = pathname.slice(0, -1);
    }
    
    // .html ile bitiyorsa
    if (pathname.endsWith('.html')) {
        // Klas√∂r yapƒ±sƒ±nƒ± koru: admin/user/page.html -> admin/user/page.html
        const result = pathname.startsWith('/') ? pathname.substring(1) : pathname;
        return result;
    }
    
    // WordPress yapƒ±sƒ± i√ßin
    if (config.supportWordPressStructure && pathname) {
        const segments = pathname.split('/').filter(s => s);
        
        if (segments.length === 0) {
            return 'index.html';
        }
        
        // Klas√∂r yapƒ±sƒ±nƒ± koru: /admin/user -> admin/user.html
        if (segments.length > 1) {
            const folderPath = segments.slice(0, -1).join('/');
            const fileName = segments[segments.length - 1];
            const result = `${folderPath}/${fileName}.html`;
            return result;
        } else {
            // Tek segment: /user -> user.html
            const result = `${segments[0]}.html`;
            return result;
        }
    }
    
    return 'index.html';
}

// Cookie string'ini olu≈ütur
function createCookieHeader(cookie) {
    if (!cookie) return null;
    
    if (typeof cookie === 'string') {
        return cookie;
    }
    
    if (typeof cookie === 'object' && cookie.name && cookie.value) {
        return `${cookie.name}=${cookie.value}`;
    }
    
    return null;
}

async function downloadTemplate(templateUrl, index, options = {}, cookie = null) {
    const templateName = `template-${index + 1}`;
    
    // Output directory'yi belirle (path artƒ±k zorunlu)
    const outputDir = path.resolve(options.path, templateName);
    
    console.log(`üì¶ ${templateName} indiriliyor...`);
    
    // Cookie header'ƒ±nƒ± hazƒ±rla
    const cookieHeader = createCookieHeader(cookie);
    if (cookieHeader) {
        console.log(`üç™ Cookie kullanƒ±lƒ±yor: ${cookieHeader.substring(0, 50)}...`);
    }
    
    try {
        // Output klas√∂r√ºn√º temizle ve olu≈ütur
        await fs.remove(outputDir);
        await fs.ensureDir(outputDir);
        
        // ƒ∞ndirilen sayfalarƒ± ve dosyalarƒ± takip et
        const downloadedPages = new Set();
        const downloadedFiles = new Set(); // Dosya tekrarƒ±nƒ± √∂nlemek i√ßin
        const pagesToDownload = [templateUrl];
        
        // Base URL'i al
        const baseUrl = templateUrl.substring(0, templateUrl.lastIndexOf('/'));
        
        while (pagesToDownload.length > 0) {
            const currentUrl = pagesToDownload.shift();
            
            if (downloadedPages.has(currentUrl)) {
                continue;
            }
            
            downloadedPages.add(currentUrl);
            console.log(`üìÑ Sayfa indiriliyor: ${path.basename(currentUrl)}`);
            
            // HTML dosyasƒ±nƒ± indir
            let response;
            try {
                const requestOptions = { 
                    timeout: config.requestTimeout 
                };
                
                // Cookie varsa header'a ekle
                if (cookieHeader) {
                    requestOptions.headers = {
                        'Cookie': cookieHeader
                    };
                }
                
                response = await axios.get(currentUrl, requestOptions);
            } catch (error) {
                console.log(`‚ö†Ô∏è  ${currentUrl} indirilemedi: ${error.message}`);
                continue;
            }
            
            const html = response.data;
            const $ = cheerio.load(html);
            
            // Bu sayfadaki diƒüer HTML linklerini bul
            const htmlLinks = findHtmlLinks($, baseUrl);
            htmlLinks.forEach(link => {
                if (!downloadedPages.has(link) && !pagesToDownload.includes(link)) {
                    pagesToDownload.push(link);
                }
            });
            
            // CSS dosyalarƒ±nƒ± indir
            const cssPromises = [];
            $('link[rel="stylesheet"]').each((i, elem) => {
                const href = $(elem).attr('href');
                if (href && !href.startsWith('http') && !href.startsWith('//')) {
                    const fullUrl = url.resolve(baseUrl + '/', href);
                    
                    // Dosya daha √∂nce indirildi mi kontrol et
                    if (!downloadedFiles.has(fullUrl)) {
                        downloadedFiles.add(fullUrl);
                        const localPath = getLocalFilePath(href, outputDir);
                        
                        cssPromises.push(
                            downloadFile(fullUrl, localPath, cookieHeader).then(async () => {
                                console.log(`üìÑ CSS: ${href}`);
                                
                                // CSS i√ßindeki kaynaklarƒ± da indir
                                try {
                                    const cssRequestOptions = { timeout: config.requestTimeout };
                                    if (cookieHeader) {
                                        cssRequestOptions.headers = { 'Cookie': cookieHeader };
                                    }
                                    
                                    const cssResponse = await axios.get(fullUrl, cssRequestOptions);
                                    await processCssUrls(cssResponse.data, fullUrl, outputDir, cookieHeader, downloadedFiles);
                                } catch (error) {
                                    console.log(`‚ö†Ô∏è  CSS i√ßeriƒüi i≈ülenemedi: ${href}`);
                                }
                            })
                        );
                    }
                    
                    // HTML'deki href'i orijinal yapƒ±da bƒ±rak
                    $(elem).attr('href', getRelativePathForHtml(href));
                }
            });
            
            // JavaScript dosyalarƒ±nƒ± indir
            const jsPromises = [];
            $('script[src]').each((i, elem) => {
                const src = $(elem).attr('src');
                if (src && !src.startsWith('http') && !src.startsWith('//')) {
                    const fullUrl = url.resolve(baseUrl + '/', src);
                    
                    // Dosya daha √∂nce indirildi mi kontrol et
                    if (!downloadedFiles.has(fullUrl)) {
                        downloadedFiles.add(fullUrl);
                        const localPath = getLocalFilePath(src, outputDir);
                        
                        jsPromises.push(
                            downloadFile(fullUrl, localPath, cookieHeader).then(() => {
                                console.log(`üìÑ JS: ${src}`);
                            })
                        );
                    }
                    
                    // HTML'deki src'yi orijinal yapƒ±da bƒ±rak
                    $(elem).attr('src', getRelativePathForHtml(src));
                }
            });
            
            // Resimleri indir
            const imgPromises = [];
            $('img').each((i, elem) => {
                const src = $(elem).attr('src');
                if (src && !src.startsWith('http') && !src.startsWith('//') && !src.startsWith('data:')) {
                    const fullUrl = url.resolve(baseUrl + '/', src);
                    
                    // Dosya daha √∂nce indirildi mi kontrol et
                    if (!downloadedFiles.has(fullUrl)) {
                        downloadedFiles.add(fullUrl);
                        const localPath = getLocalFilePath(src, outputDir);
                        
                        imgPromises.push(
                            downloadFile(fullUrl, localPath, cookieHeader).then(() => {
                                console.log(`üìÑ IMG: ${src}`);
                            })
                        );
                    }
                    
                    // HTML'deki src'yi orijinal yapƒ±da bƒ±rak
                    $(elem).attr('src', getRelativePathForHtml(src));
                }
            });
            
            // Background image'larƒ± indir
            $('[style*="background-image"]').each((i, elem) => {
                const style = $(elem).attr('style');
                if (style) {
                    const bgMatch = style.match(/background-image:\s*url\(['"]?([^'")\s]+)['"]?\)/);
                    if (bgMatch && bgMatch[1] && !bgMatch[1].startsWith('http') && !bgMatch[1].startsWith('data:')) {
                        const bgUrl = bgMatch[1];
                        const fullUrl = url.resolve(baseUrl + '/', bgUrl);
                        
                        // Dosya daha √∂nce indirildi mi kontrol et
                        if (!downloadedFiles.has(fullUrl)) {
                            downloadedFiles.add(fullUrl);
                            const localPath = getLocalFilePath(bgUrl, outputDir);
                            
                            imgPromises.push(
                                downloadFile(fullUrl, localPath, cookieHeader).then(() => {
                                    console.log(`üìÑ BG: ${bgUrl}`);
                                })
                            );
                        }
                        
                        // Style'daki URL'yi orijinal yapƒ±da bƒ±rak
                        const newStyle = style.replace(bgMatch[1], getRelativePathForHtml(bgUrl));
                        $(elem).attr('style', newStyle);
                    }
                }
            });
            
            // HTML linklerini yerel yollara d√∂n√º≈üt√ºr
            $('a[href]').each((i, elem) => {
                const href = $(elem).attr('href');
                if (href && !href.startsWith('http') && !href.startsWith('//') && !href.startsWith('#') && !href.startsWith('mailto:') && !href.startsWith('tel:')) {
                    if (isPageUrl(url.resolve(baseUrl + '/', href))) {
                        const targetUrl = url.resolve(baseUrl + '/', href);
                        const fileName = getPageFileName(targetUrl);
                        // Klas√∂r yapƒ±sƒ±nƒ± koruyarak relatif yol olu≈ütur
                        $(elem).attr('href', fileName);
                    }
                }
            });
            
            // T√ºm indirmeleri bekle
            await Promise.all([...cssPromises, ...jsPromises, ...imgPromises]);
            
            // G√ºncellenmi≈ü HTML'i kaydet
            const updatedHtml = $.html();
            const pageFileName = getPageFileName(currentUrl);
            const fullPagePath = path.join(outputDir, pageFileName);
            
            // Klas√∂r yapƒ±sƒ±nƒ± olu≈ütur
            await fs.ensureDir(path.dirname(fullPagePath));
            await fs.writeFile(fullPagePath, updatedHtml);
        }
        
        console.log(`‚úÖ ${templateName} ba≈üarƒ±yla indirildi:`);
        console.log(`   üìÑ ${downloadedPages.size} sayfa indirildi`);
        console.log(`   üìÅ ${downloadedFiles.size} dosya indirildi`);
        console.log(`   üìÇ Konum: ${outputDir}`);
        
    } catch (error) {
        console.error(`‚ùå ${templateName} indirme hatasƒ±:`, error.message);
    }
}

async function downloadAllTemplates(urls = templateUrls, options = {}, cookie = null) {
    // Path zorunlu kontrol
    if (!options.path) {
        throw new Error('options.path zorunludur! √ñrnek: { path: "./theme" }');
    }
    
    // Konfig√ºrasyonu g√ºncelle
    const finalConfig = { ...config, ...options };
    Object.assign(config, finalConfig);
    
    console.log('üöÄ Tema indirme i≈ülemi ba≈ülatƒ±lƒ±yor...\n');
    console.log(`üìã Konfig√ºrasyon:`);
    console.log(`   WordPress yapƒ±sƒ±: ${config.supportWordPressStructure ? 'Aktif' : 'Pasif'}`);
    console.log(`   Maksimum derinlik: ${config.maxDepth}`);
    console.log(`   Request timeout: ${config.requestTimeout}ms`);
    console.log(`   Output klas√∂r√º: ${options.path}`);
    if (cookie) {
        console.log(`   Cookie kullanƒ±mƒ±: Aktif`);
    }
    console.log('');
    
    // Ana klas√∂r√º olu≈ütur
    const mainDir = path.resolve(options.path);
    await fs.ensureDir(mainDir);
    
    // Her template'i sƒ±rayla indir
    for (let i = 0; i < urls.length; i++) {
        await downloadTemplate(urls[i], i, options, cookie);
        console.log(''); // Bo≈ü satƒ±r ekle
    }
    
    console.log('üéâ T√ºm temalar ba≈üarƒ±yla indirildi!');
    console.log(`üìÇ ƒ∞ndirilen temalar: ${path.resolve(options.path)}`);
}

// NPM mod√ºl√º olarak export et
module.exports = {
    downloadAllTemplates,
    downloadTemplate,
    config
};

// Eƒüer dosya direkt √ßalƒ±≈ütƒ±rƒ±lƒ±yorsa otomatik ba≈ülat
if (require.main === module) {
    downloadAllTemplates(templateUrls, { 
        path: './downloaded-themes',
        supportWordPressStructure: true 
    }).catch(console.error);
}